<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Efe'nin Takip Haritası</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
html,body,#map{height:100%;margin:0;padding:0;}
#status{position:absolute;left:10px;top:10px;z-index:999;background:#fff;padding:6px 10px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.3);}
</style>
</head>
<body>
<div id="status">📡 Veri bekleniyor...</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const statusBox = document.getElementById('status');
const map = L.map('map').setView([36.2,36.17],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const params = new URLSearchParams(location.search);
const logUrl = params.get('log_url');

function parseLog(text){
  const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const pts=[];
  for(const l of lines){
    const c=l.split(',');
    if(c.length<3) continue;
    const time=c[0].trim(),lat=parseFloat(c[1]),lon=parseFloat(c[2]);
    if(isNaN(lat)||isNaN(lon)) continue;
    const speed=c[3]?parseFloat(c[3]):null;
    const heading=c[4]?parseFloat(c[4]):null;
    pts.push({time,lat,lon,speed,heading});
  }
  return pts;
}

async function loadAndDraw(){
  if(!logUrl){ statusBox.textContent="❌ log_url belirtilmemiş."; return; }
  try{
    statusBox.textContent="🔄 Log indiriliyor...";
    const res = await fetch(logUrl);
    if(!res.ok) throw new Error("HTTP "+res.status);
    const text = await res.text();
    const pts = parseLog(text);
    if(!pts.length){ statusBox.textContent="⚠️ Geçerli veri yok."; return; }

    const latlngs = pts.map(p=>[p.lat,p.lon]);
    const poly=L.polyline(latlngs,{color:'blue',weight:4}).addTo(map);
    map.fitBounds(poly.getBounds(),{maxZoom:18});
    pts.forEach(p=>{
      L.circleMarker([p.lat,p.lon],{radius:4})
        .addTo(map)
        .bindPopup(`<b>${p.time}</b><br>Hız: ${p.speed??'-'}<br>Yön: ${p.heading??'-'}`);
    });
    statusBox.textContent=`✅ ${pts.length} nokta çizildi.`;
  }catch(e){
    statusBox.innerHTML=`⚠️ CORS engeli veya bağlantı hatası.<br><small>${e.message}</small><br><br>💡 Dosyayı manuel seç:<br><input type=file id=fileInput>`;
    const fi=document.getElementById('fileInput');
    fi.addEventListener('change',ev=>{
      const reader=new FileReader();
      reader.onload=ev2=>{
        const pts=parseLog(ev2.target.result);
        const latlngs=pts.map(p=>[p.lat,p.lon]);
        L.polyline(latlngs,{color:'blue',weight:4}).addTo(map);
        map.fitBounds(L.polyline(latlngs).getBounds(),{maxZoom:18});
        statusBox.textContent=`🗂️ ${pts.length} nokta çizildi (manuel).`;
      };
      reader.readAsText(ev.target.files[0]);
    });
  }
}
loadAndDraw();
</script>
</body>
</html>